<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Hub — в стиле CoinGecko</title>
  <meta name="description" content="Лёгкий, независимый крипто-дэшборд с данными CoinGecko и графиками TradingView"/>
  <link rel="preconnect" href="https://api.coingecko.com"/>
  <link rel="preconnect" href="https://s3.tradingview.com"/>

  <style>
    :root {
      --bg: #0f131a;
      --card: #151a23;
      --text: #e7ecf3;
      --muted: #a8b0bd;
      --accent: #4cc9f0;
      --accent-2: #00e1a5;
      --red: #ff6b6b;
      --green: #2ecc71;
      --border: #232a35;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --table-even: #131821;
      --link: #9dd8ff;
    }
    [data-theme="light"] {
      --bg: #f7f9fc;
      --card: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --accent: #2563eb;
      --accent-2: #059669;
      --red: #dc2626;
      --green: #16a34a;
      --border: #e5e7eb;
      --shadow: 0 6px 16px rgba(0,0,0,0.12);
      --table-even: #f3f4f6;
      --link: #1d4ed8;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg);
      color: var(--text);
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(20,24,31,0.7) 100%);
    }
    .nav {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background-color: var(--card);
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
    }
    .brand h1 {
      font-size: 18px; margin: 0;
      letter-spacing: 0.2px;
    }

    .controls {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: center;
    }
    .control {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--table-even); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px;
    }
    .control input[type="text"] {
      background: transparent; border: none; outline: none; color: var(--text);
      width: 240px;
    }
    .control select, .control button {
      background: transparent; border: none; color: var(--text);
      cursor: pointer;
    }
    .control button {
      padding: 4px 10px; border-radius: 8px;
      border: 1px solid var(--border);
    }
    .links {
      display: flex; gap: 10px;
    }
    .links a {
      color: var(--link); text-decoration: none; font-weight: 600;
      padding: 8px 12px; border-radius: 8px;
    }
    .links a:hover { text-decoration: underline; }

    /* Stats bar */
    .stats {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 12px; padding: 14px 20px; background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .stat {
      background: var(--table-even); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px;
    }
    .stat .label { color: var(--muted); font-size: 12px; }
    .stat .value { font-size: 16px; font-weight: 700; margin-top: 4px; }

    /* Table container */
    .container { max-width: 1280px; margin: 20px auto; padding: 0 16px; }
    .panel {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; font-size: 12px; color: var(--muted);
      background: var(--table-even); padding: 10px;
      border-bottom: 1px solid var(--border); user-select: none; cursor: pointer;
    }
    tbody td {
      padding: 12px 10px; border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    tbody tr:hover { background: rgba(76,201,240,0.08); }
    .coin {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer;
    }
    .coin img {
      width: 24px; height: 24px; border-radius: 12px; border: 1px solid var(--border);
    }
    .spark {
      height: 36px; width: 120px;
    }
    .price-up { color: var(--green); }
    .price-down { color: var(--red); }
    .badge {
      display: inline-block; padding: 2px 6px; border-radius: 6px;
      font-size: 11px; border: 1px solid var(--border); color: var(--muted);
    }
    .fav {
      color: var(--accent); cursor: pointer; user-select: none;
      font-weight: 700; font-size: 16px;
    }

    /* Pagination & footer controls */
    .footer-controls {
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      padding: 12px; background: var(--table-even);
      border-top: 1px solid var(--border);
    }
    .pager, .page-size {
      display: flex; align-items: center; gap: 8px;
    }
    .pager button {
      background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; cursor: pointer;
    }
    .pager button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal {
      width: min(980px, 96vw); max-height: 90vh; overflow: auto;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; box-shadow: var(--shadow);
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--card); z-index: 2;
    }
    .modal-header h3 {
      margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px;
    }
    .modal-content { padding: 14px; display: grid; gap: 14px; }
    .kv {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    }
    .kv .item {
      background: var(--table-even); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px;
    }
    .kv .item .label { color: var(--muted); font-size: 12px; }
    .kv .item .value { font-size: 16px; font-weight: 700; margin-top: 4px; }
    .modal-section {
      background: var(--table-even); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px;
    }
    .modal-footer {
      padding: 12px; border-top: 1px solid var(--border);
      display: flex; justify-content: flex-end; gap: 8px; position: sticky; bottom: 0;
      background: var(--card);
    }
    .btn {
      border: 1px solid var(--border); background: transparent; color: var(--text);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }
    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none; color: white; font-weight: 700;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .kv { grid-template-columns: repeat(2, 1fr); }
      .spark { display: none; }
      .controls .control input[type="text"] { width: 160px; }
    }
    @media (max-width: 600px) {
      .stats { grid-template-columns: 1fr; }
      .kv { grid-template-columns: 1fr; }
      .nav { grid-template-columns: 1fr; }
      .links { justify-content: center; }
    }
  </style>
</head>
<body data-theme="dark">
<header>
  <div class="nav">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Crypto Hub</h1>
      <span class="badge">Independent</span>
    </div>

    <div class="controls">
      <div class="control" title="Поиск по названию/тикеру">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" type="text" placeholder="Поиск монет..." />
      </div>

      <div class="control" title="Сортировка">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M6 12h12M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <select id="sort">
          <option value="market_cap_desc">Рыночная капа ↓</option>
          <option value="market_cap_asc">Рыночная капа ↑</option>
          <option value="volume_desc">Объём ↓</option>
          <option value="volume_asc">Объём ↑</option>
          <option value="price_desc">Цена ↓</option>
          <option value="price_asc">Цена ↑</option>
          <option value="change_desc">Изм. 24ч ↓</option>
          <option value="change_asc">Изм. 24ч ↑</option>
        </select>
      </div>

      <div class="control" title="Тема">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v2M12 19v2M3 12h2M19 12h2M5 5l1.5 1.5M17.5 17.5L19 19M19 5l-1.5 1.5M5 19l1.5-1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/></svg>
        <button id="toggleTheme">Сменить тему</button>
      </div>

      <div class="control" title="Избранное">
        <span>Показывать избранное</span>
        <input id="favOnly" type="checkbox"/>
      </div>
    </div>

    <div class="links">
      <a href="https://www.coingecko.com" target="_blank" rel="noopener">CoinGecko</a>
      <a href="https://www.tradingview.com" target="_blank" rel="noopener">TradingView</a>
      <a href="#" id="exportZip" title="Подготовка ZIP-гайда">Deploy Guide</a>
    </div>
  </div>

  <div class="stats" id="globalStats">
    <div class="stat">
      <div class="label">Рынок</div>
      <div class="value" id="statDominance">BTC доминирование</div>
    </div>
    <div class="stat">
      <div class="label">Капитализация</div>
      <div class="value" id="statMarketCap">—</div>
    </div>
    <div class="stat">
      <div class="label">24ч объём</div>
      <div class="value" id="statVolume">—</div>
    </div>
    <div class="stat">
      <div class="label">Монет</div>
      <div class="value" id="statCount">—</div>
    </div>
  </div>
</header>

<main class="container">
  <section class="panel">
    <table id="coinsTable" aria-label="Список криптовалют">
      <thead>
        <tr>
          <th data-key="rank">#</th>
          <th>Монета</th>
          <th data-key="price">Цена</th>
          <th data-key="change">24ч</th>
          <th data-key="market_cap">Капитализация</th>
          <th data-key="volume">Объём 24ч</th>
          <th>Спарк</th>
          <th>Бирки</th>
          <th>Избр.</th>
        </tr>
      </thead>
      <tbody id="coinsBody">
        <!-- Рендерится JS -->
      </tbody>
    </table>

    <div class="footer-controls">
      <div class="pager">
        <button id="prevPage">Назад</button>
        <span id="pageInfo" class="badge">Стр. 1</span>
        <button id="nextPage">Вперёд</button>
      </div>
      <div class="page-size">
        <span class="badge">На странице</span>
        <select id="pageSize">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
        </select>
      </div>
      <div class="refresh">
        <button id="refreshBtn" class="btn">Обновить</button>
        <span class="badge" id="lastUpdate">—</span>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <h3><img id="modalIcon" src="" alt="" style="width:20px;height:20px;border-radius:10px;border:1px solid var(--border)"> <span id="modalTitle">Монета</span></h3>
      <button id="closeModal" class="btn">Закрыть</button>
    </div>
    <div class="modal-content">
      <div class="kv">
        <div class="item"><div class="label">Цена</div><div class="value" id="mPrice">—</div></div>
        <div class="item"><div class="label">24ч изм.</div><div class="value" id="mChange">—</div></div>
        <div class="item"><div class="label">Капа</div><div class="value" id="mCap">—</div></div>
        <div class="item"><div class="label">Объём 24ч</div><div class="value" id="mVol">—</div></div>
        <div class="item"><div class="label">Поставка</div><div class="value" id="mSupply">—</div></div>
        <div class="item"><div class="label">Ранг</div><div class="value" id="mRank">—</div></div>
      </div>

      <div class="modal-section">
        <div id="tvWidget" style="height: 420px;"></div>
      </div>

      <div class="modal-section">
        <h4 style="margin-top:0">Описание</h4>
        <div id="mDescription" style="color:var(--muted); line-height:1.5">—</div>
      </div>

      <div class="modal-section">
        <h4 style="margin-top:0">Ссылки</h4>
        <div id="mLinks" style="display:flex; gap:10px; flex-wrap:wrap"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="modalFavToggle" class="btn">В избранное</button>
      <button id="openOnCG" class="btn">Открыть на CoinGecko</button>
      <button id="copySymbol" class="btn">Скопировать тикер</button>
      <button id="modalTheme" class="btn">Тёмная тема графика</button>
      <button id="modalRefresh" class="btn primary">Обновить данные</button>
    </div>
  </div>
</div>

<footer class="container" style="margin-bottom:40px">
  <section class="panel" style="padding:14px">
    <h3 style="margin-top:0">О проекте</h3>
    <p>Независимый хаб в стиле CoinGecko. Данные — реальный API CoinGecko, графики — TradingView. Никаких сборок, только чистый HTML/CSS/JS. Готов к размещению на GitHub Pages, Netlify или любом хостинге.</p>
    <p>Советы: не обновляйте слишком часто, уважайте лимиты API. Избранное и тема — сохраняются в LocalStorage. В модалке — расширенные детали и график с автоподбором тикера.</p>
  </section>
</footer>

<!-- TradingView Widget script -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
(function() {
  const state = {
    coins: [],
    filtered: [],
    page: 1,
    pageSize: 50,
    sort: 'market_cap_desc',
    search: '',
    favOnly: false,
    favorites: new Set(JSON.parse(localStorage.getItem('favorites') || '[]')),
    theme: localStorage.getItem('theme') || 'dark',
    lastUpdate: null,
    global: null,
    modal: { id: null, symbol: null, tvTheme: 'dark' },
  };

  const dom = {
    body: document.body,
    search: document.getElementById('search'),
    sort: document.getElementById('sort'),
    favOnly: document.getElementById('favOnly'),
    pageSize: document.getElementById('pageSize'),
    prevPage: document.getElementById('prevPage'),
    nextPage: document.getElementById('nextPage'),
    pageInfo: document.getElementById('pageInfo'),
    refreshBtn: document.getElementById('refreshBtn'),
    lastUpdate: document.getElementById('lastUpdate'),
    coinsBody: document.getElementById('coinsBody'),
    statDominance: document.getElementById('statDominance'),
    statMarketCap: document.getElementById('statMarketCap'),
    statVolume: document.getElementById('statVolume'),
    statCount: document.getElementById('statCount'),
    toggleTheme: document.getElementById('toggleTheme'),
    exportZip: document.getElementById('exportZip'),
    modalBackdrop: document.getElementById('modalBackdrop'),
    closeModal: document.getElementById('closeModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalIcon: document.getElementById('modalIcon'),
    mPrice: document.getElementById('mPrice'),
    mChange: document.getElementById('mChange'),
    mCap: document.getElementById('mCap'),
    mVol: document.getElementById('mVol'),
    mSupply: document.getElementById('mSupply'),
    mRank: document.getElementById('mRank'),
    mDescription: document.getElementById('mDescription'),
    mLinks: document.getElementById('mLinks'),
    tvWidget: document.getElementById('tvWidget'),
    modalFavToggle: document.getElementById('modalFavToggle'),
    openOnCG: document.getElementById('openOnCG'),
    copySymbol: document.getElementById('copySymbol'),
    modalTheme: document.getElementById('modalTheme'),
    modalRefresh: document.getElementById('modalRefresh'),
  };

  // Apply initial theme
  document.body.setAttribute('data-theme', state.theme);

  // Utils
  const fmt = {
    money(v) {
      if (v === null || v === undefined) return '—';
      const abs = Math.abs(v);
      const opts = { maximumFractionDigits: abs < 1 ? 6 : abs < 100 ? 4 : 2 };
      return '$' + Number(v).toLocaleString('en-US', opts);
    },
    num(v) {
      if (v === null || v === undefined) return '—';
      return Number(v).toLocaleString('en-US', { maximumFractionDigits: 0 });
    },
    pct(v) {
      if (v === null || v === undefined) return '—';
      const s = (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
      return s;
    },
    time(ts) {
      if (!ts) return '—';
      const d = new Date(ts);
      return d.toLocaleString();
    },
    trimHtml(html, limit=600) {
      if (!html) return '—';
      const s = html.replace(/<[^>]+>/g, '');
      return s.length > limit ? s.slice(0, limit) + '…' : s;
    }
  };

  // Mapping CoinGecko symbols to TradingView symbols
  const tvSymbolMap = {
    'btc': 'BINANCE:BTCUSDT',
    'eth': 'BINANCE:ETHUSDT',
    'usdt': 'BINANCE:USDTUSD',
    'bnb': 'BINANCE:BNBUSDT',
    'sol': 'BINANCE:SOLUSDT',
    'xrp': 'BINANCE:XRPUSDT',
    'ada': 'BINANCE:ADAUSDT',
    'doge': 'BINANCE:DOGEUSDT',
    'ton': 'BINANCE:TONUSDT',
    'trx': 'BINANCE:TRXUSDT',
    'matic': 'BINANCE:MATICUSDT',
    'link': 'BINANCE:LINKUSDT',
    'dot': 'BINANCE:DOTUSDT',
    'ltc': 'BINANCE:LTCUSDT',
    'bch': 'BINANCE:BCHUSDT',
    'avax': 'BINANCE:AVAXUSDT',
    'xmr': 'BINANCE:XMRUSDT',
    'atom': 'BINANCE:ATOMUSDT',
    'etc': 'BINANCE:ETCUSDT',
    'xlm': 'BINANCE:XLMUSDT',
    'unmapped': 'CRYPTOCAP:BTC.D' // fallback: доминирование BTC
  };
  function toTVSymbol(symbol) {
    const s = (symbol || '').toLowerCase();
    return tvSymbolMap[s] || `BINANCE:${s.toUpperCase()}USDT`;
  }

  // API layer
  const API = {
    base: 'https://api.coingecko.com/api/v3',
    async markets({ page, perPage, order, currency='usd' }) {
      // order: market_cap_desc | market_cap_asc | volume_desc | volume_asc | price_desc | price_asc | change_desc | change_asc
      const cgOrderMap = {
        market_cap_desc: 'market_cap_desc',
        market_cap_asc: 'market_cap_asc',
        volume_desc: 'volume_desc',
        volume_asc: 'volume_asc',
        price_desc: 'market_cap_desc', // We will sort client-side by price
        price_asc: 'market_cap_asc',
        change_desc: 'market_cap_desc', // client-side by change
        change_asc: 'market_cap_asc',
      };
      const url = `${this.base}/coins/markets?vs_currency=${currency}&order=${cgOrderMap[order] || 'market_cap_desc'}&per_page=${Math.min(perPage,250)}&page=${page}&sparkline=true&price_change_percentage=1h,24h,7d`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    },
    async global() {
      const url = `${this.base}/global`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    },
    async coinDetail(id) {
      const url = `${this.base}/coins/${id}?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=true`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    }
  };

  // State persistence
  function saveFavorites() {
    localStorage.setItem('favorites', JSON.stringify([...state.favorites]));
  }
  function setTheme(t) {
    state.theme = t;
    localStorage.setItem('theme', t);
    dom.body.setAttribute('data-theme', t);
  }

  // Filtering, sorting, pagination
  function applyFilters() {
    const q = state.search.trim().toLowerCase();
    let data = state.coins;
    if (q) {
      data = data.filter(c =>
        c.name.toLowerCase().includes(q) ||
        c.symbol.toLowerCase().includes(q)
      );
    }
    if (state.favOnly) {
      data = data.filter(c => state.favorites.has(c.id));
    }

    // client-side sort variants
    const sort = state.sort;
    if (sort === 'price_desc') data.sort((a,b) => b.current_price - a.current_price);
    else if (sort === 'price_asc') data.sort((a,b) => a.current_price - b.current_price);
    else if (sort === 'volume_desc') data.sort((a,b) => b.total_volume - a.total_volume);
    else if (sort === 'volume_asc') data.sort((a,b) => a.total_volume - b.total_volume);
    else if (sort === 'change_desc') data.sort((a,b) => (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0));
    else if (sort === 'change_asc') data.sort((a,b) => (a.price_change_percentage_24h || 0) - (b.price_change_percentage_24h || 0));
    else if (sort === 'market_cap_asc') data.sort((a,b) => a.market_cap - b.market_cap);
    else data.sort((a,b) => b.market_cap - a.market_cap);

    state.filtered = data;
    renderTable();
  }

  function setPage(p) {
    const max = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
    state.page = Math.min(Math.max(1, p), max);
    dom.pageInfo.textContent = `Стр. ${state.page} / ${max}`;
    dom.prevPage.disabled = state.page <= 1;
    dom.nextPage.disabled = state.page >= max;
    renderTable();
  }

  function renderTable() {
    const start = (state.page - 1) * state.pageSize;
    const view = state.filtered.slice(start, start + state.pageSize);
    const rows = view.map((c, idx) => {
      const change = c.price_change_percentage_24h;
      const chClass = change >= 0 ? 'price-up' : 'price-down';
      const fav = state.favorites.has(c.id) ? '★' : '☆';
      const rank = c.market_cap_rank ?? '—';
      const badges = [
        c.symbol.toUpperCase(),
        (c.price_change_percentage_7d_in_currency!=null ? '7д ' + (c.price_change_percentage_7d_in_currency>=0?'+':'') + c.price_change_percentage_7d_in_currency.toFixed(2)+'%' : null),
        (c.price_change_percentage_1h_in_currency!=null ? '1ч ' + (c.price_change_percentage_1h_in_currency>=0?'+':'') + c.price_change_percentage_1h_in_currency.toFixed(2)+'%' : null),
      ].filter(Boolean).map(x => `<span class="badge">${x}</span>`).join(' ');

      // Inline sparkline (canvas)
      const sparkId = `spark-${c.id}`;

      return `
        <tr data-id="${c.id}">
          <td>${rank}</td>
          <td>
            <div class="coin" data-coin="${c.id}">
              <img src="${c.image}" alt="${c.name}" loading="lazy"/>
              <div>
                <div style="font-weight:700">${c.name}</div>
                <div class="badge">${c.symbol.toUpperCase()}</div>
              </div>
            </div>
          </td>
          <td>${fmt.money(c.current_price)}</td>
          <td class="${chClass}">${fmt.pct(change ?? 0)}</td>
          <td>${fmt.money(c.market_cap)}</td>
          <td>${fmt.money(c.total_volume)}</td>
          <td><canvas class="spark" id="${sparkId}" width="120" height="36"></canvas></td>
          <td>${badges}</td>
          <td><span class="fav" data-fav="${c.id}" title="Избранное">${fav}</span></td>
        </tr>
      `;
    }).join('');
    dom.coinsBody.innerHTML = rows;

    // Bind row click to modal
    [...dom.coinsBody.querySelectorAll('.coin')].forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-coin');
        openModal(id);
      });
    });
    // Fav toggles
    [...dom.coinsBody.querySelectorAll('.fav')].forEach(el => {
      el.addEventListener('click', (e) => {
        const id = el.getAttribute('data-fav');
        toggleFav(id);
        e.stopPropagation();
      });
    });
    // Render sparklines
    view.forEach(c => drawSpark(c));
  }

  function drawSpark(c) {
    const canvas = document.getElementById('spark-' + c.id);
    if (!canvas || !c.sparkline_in_7d || !c.sparkline_in_7d.price) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    const data = c.sparkline_in_7d.price;
    const min = Math.min(...data), max = Math.max(...data);
    const pad = 4;
    ctx.strokeStyle = (data[data.length-1] >= data[0]) ? getComputedStyle(document.body).getPropertyValue('--green').trim() : getComputedStyle(document.body).getPropertyValue('--red').trim();
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    data.forEach((v, i) => {
      const x = pad + i * ((w - pad*2) / (data.length - 1));
      const y = h - pad - ( (v - min) / (max - min || 1) ) * (h - pad*2);
      if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  // Favorites
  function toggleFav(id) {
    if (state.favorites.has(id)) state.favorites.delete(id);
    else state.favorites.add(id);
    saveFavorites();
    applyFilters();
  }

  // Modal
  let tvChart = null;
  async function openModal(id) {
    try {
      dom.modalBackdrop.style.display = 'flex';
      dom.modalBackdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      // Fetch details
      const detail = await API.coinDetail(id);
      const market = state.coins.find(x => x.id === id) || {};
      state.modal.id = id;
      state.modal.symbol = (market.symbol || detail.symbol || '').toUpperCase();

      // Fill header
      dom.modalTitle.textContent = detail.name + ' (' + state.modal.symbol + ')';
      dom.modalIcon.src = detail.image?.small || market.image || '';
      dom.mPrice.textContent = fmt.money(market.current_price ?? detail.market_data?.current_price?.usd);
      dom.mChange.textContent = fmt.pct(market.price_change_percentage_24h ?? detail.market_data?.price_change_percentage_24h);
      dom.mChange.className = (market.price_change_percentage_24h ?? 0) >= 0 ? 'value price-up' : 'value price-down';
      dom.mCap.textContent = fmt.money(market.market_cap ?? detail.market_data?.market_cap?.usd);
      dom.mVol.textContent = fmt.money(market.total_volume ?? detail.market_data?.total_volume?.usd);
      dom.mSupply.textContent = fmt.num(detail.market_data?.circulating_supply) + ' / ' + fmt.num(detail.market_data?.total_supply);
      dom.mRank.textContent = detail.market_cap_rank ?? market.market_cap_rank ?? '—';

      // Description
      dom.mDescription.textContent = fmt.trimHtml(detail.description?.ru || detail.description?.en || detail.description?.en_US || '');

      // Links
      const links = [];
      const ll = detail.links || {};
      if (ll.homepage?.[0]) links.push({ label: 'Сайт', url: ll.homepage[0] });
      if (ll.blockchain_site?.[0]) links.push({ label: 'Explorer', url: ll.blockchain_site[0] });
      if (ll.reddit_subscribers) links.push({ label: 'Reddit', url: ll.subreddit_url || 'https://reddit.com' });
      if (ll.twitter_screen_name) links.push({ label: 'Twitter', url: 'https://x.com/' + ll.twitter_screen_name });
      if (ll.repos_url?.github?.[0]) links.push({ label: 'GitHub', url: ll.repos_url.github[0] });

      dom.mLinks.innerHTML = links.map(l => `<a class="badge" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`).join(' ') || '<span class="badge">Нет ссылок</span>';

      // Buttons
      dom.openOnCG.onclick = () => window.open('https://www.coingecko.com/coins/' + detail.id, '_blank');
      dom.copySymbol.onclick = async () => {
        try { await navigator.clipboard.writeText(state.modal.symbol); dom.copySymbol.textContent = 'Скопировано'; setTimeout(() => dom.copySymbol.textContent = 'Скопировать тикер', 1200); } catch(e){}
      };
      dom.modalFavToggle.textContent = state.favorites.has(id) ? 'Убрать из избранного' : 'В избранное';
      dom.modalFavToggle.onclick = () => { toggleFav(id); dom.modalFavToggle.textContent = state.favorites.has(id) ? 'Убрать из избранного' : 'В избранное'; };

      // TradingView
      renderTVChart(state.modal.symbol);

      dom.modalRefresh.onclick = async () => {
        const detail2 = await API.coinDetail(id);
        const market2 = await API.markets({ page: 1, perPage: 1, order: state.sort });
        const m = market2[0] || {};
        dom.mPrice.textContent = fmt.money(m.current_price ?? detail2.market_data?.current_price?.usd);
        dom.mChange.textContent = fmt.pct(m.price_change_percentage_24h ?? detail2.market_data?.price_change_percentage_24h);
        dom.mChange.className = (m.price_change_percentage_24h ?? 0) >= 0 ? 'value price-up' : 'value price-down';
        dom.mCap.textContent = fmt.money(m.market_cap ?? detail2.market_data?.market_cap?.usd);
        dom.mVol.textContent = fmt.money(m.total_volume ?? detail2.market_data?.total_volume?.usd);
      };
    } catch (e) {
      console.error(e);
      alert('Не удалось открыть данные монеты. Попробуйте позже.');
      closeModal();
    }
  }

  function renderTVChart(symbol) {
    const tvTicker = toTVSymbol(symbol);
    dom.tvWidget.innerHTML = '';
    const theme = (state.modal.tvTheme === 'dark') ? 'dark' : 'light';
    // TradingView Chart
    tvChart = new TradingView.widget({
      container_id: 'tvWidget',
      autosize: true,
      symbol: tvTicker,
      interval: '60',
      timezone: 'Etc/UTC',
      theme: theme,
      style: '1',
      locale: 'ru',
      toolbar_bg: 'rgba(0,0,0,0)',
      enable_publishing: false,
      hide_side_toolbar: false,
      allow_symbol_change: true,
      withdateranges: true,
      studies: [
        'MASimple@tv-basicstudies'
      ],
    });
  }

  function closeModal() {
    dom.modalBackdrop.style.display = 'none';
    dom.modalBackdrop.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    tvChart = null;
  }

  dom.closeModal.addEventListener('click', closeModal);
  dom.modalTheme.addEventListener('click', () => {
    state.modal.tvTheme = state.modal.tvTheme === 'dark' ? 'light' : 'dark';
    dom.modalTheme.textContent = state.modal.tvTheme === 'dark' ? 'Тёмная тема графика' : 'Светлая тема графика';
    if (state.modal.symbol) renderTVChart(state.modal.symbol);
  });
  dom.modalBackdrop.addEventListener('click', (e) => {
    if (e.target === dom.modalBackdrop) closeModal();
  });

  // Global stats
  async function loadGlobal() {
    try {
      const g = await API.global();
      state.global = g.data || g;
      const mcap = state.global.total_market_cap?.usd;
      const vol = state.global.total_volume?.usd;
      const btcDom = state.global.market_cap_percentage?.btc;
      const coins = state.global.active_cryptocurrencies;

      dom.statMarketCap.textContent = fmt.money(mcap);
      dom.statVolume.textContent = fmt.money(vol);
      dom.statDominance.textContent = (btcDom != null ? btcDom.toFixed(2) + '%' : '—');
      dom.statCount.textContent = fmt.num(coins);
    } catch(e) {
      dom.statDominance.textContent = '—';
      dom.statMarketCap.textContent = '—';
      dom.statVolume.textContent = '—';
      dom.statCount.textContent = '—';
    }
  }

  // Load markets
  async function load() {
    try {
      dom.refreshBtn.disabled = true;
      const pageForAPI = 1; // мы тянем крупные монеты и сортируем/фильтруем на клиенте
      const perPage = 250;
      const order = state.sort;
      const data = await API.markets({ page: pageForAPI, perPage, order });
      state.coins = data;
      state.lastUpdate = Date.now();
      dom.lastUpdate.textContent = 'Обновлено: ' + fmt.time(state.lastUpdate);
      applyFilters();
      setPage(1);
    } catch(e) {
      alert('Ошибка загрузки данных CoinGecko. Попробуйте позже.');
    } finally {
      dom.refreshBtn.disabled = false;
    }
  }

  // Events
  dom.search.addEventListener('input', (e) => {
    state.search = e.target.value;
    applyFilters();
    setPage(1);
  });
  dom.sort.addEventListener('change', (e) => {
    state.sort = e.target.value;
    applyFilters();
    setPage(1);
  });
  dom.favOnly.addEventListener('change', (e) => {
    state.favOnly = e.target.checked;
    applyFilters();
    setPage(1);
  });
  dom.pageSize.addEventListener('change', (e) => {
    state.pageSize = parseInt(e.target.value, 10);
    setPage(1);
  });
  dom.prevPage.addEventListener('click', () => setPage(state.page - 1));
  dom.nextPage.addEventListener('click', () => setPage(state.page + 1));
  dom.refreshBtn.addEventListener('click', load);
  document.getElementById('toggleTheme').addEventListener('click', () => {
    setTheme(state.theme === 'dark' ? 'light' : 'dark');
  });

  // Deploy guide (download hints)
  dom.exportZip.addEventListener('click', (e) => {
    e.preventDefault();
    alert(
`Как разместить:
1. Сохраните этот файл как index.html.
2. Загрузите на GitHub Pages (репозиторий -> Settings -> Pages) или Netlify (drag & drop).
3. TradingView виджет грузится с CDN, CoinGecko API не требует ключа.
4. Для кросс-доменных ограничений ничего не нужно — CoinGecko отдаёт CORS-заголовки.
5. При необходимости статики — положите favicon, изображения и robots.txt рядом.
Удачного деплоя!`
    );
  });

  // Auto refresh every 60s (бережно)
  setInterval(() => {
    load();
  }, 60000);

  // Init
  loadGlobal();
  load();

})();
</script>
</body>
</html>
